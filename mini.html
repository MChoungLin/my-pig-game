<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°è±¬æŠµæŠ—å¤§é‡ç‹¼ - iPadç›´ç‰ˆ</title>
    <style>
        /* å…¨åŸŸè¨­å®šï¼šç¦æ­¢ iOS Safari çš„é è¨­è§¸æ§è¡Œç‚º */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none; /* é—œéµï¼šç¦æ­¢æ©¡çš®ç­‹æ»¾å‹•èˆ‡ç¸®æ”¾ */
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            background-color: #222; 
            display: flex; 
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
            align-items: center; 
            height: 100dvh; /* ä½¿ç”¨å‹•æ…‹é«˜åº¦é©é… Safari */
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— (åˆ†æ•¸/è¡€é‡) */
        #top-bar {
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background-color: #333;
            color: white;
            z-index: 20;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .stat {
            font-size: 20px;
            font-weight: bold;
        }

        /* éŠæˆ²ç•«å¸ƒå®¹å™¨ */
        #game-container {
            position: relative;
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #87CEEB;
        }
        
        canvas { 
            /* è®“ Canvas åœ¨ä¿æŒæ¯”ä¾‹çš„å‰æä¸‹å¡«æ»¿å®¹å™¨ */
            height: 100%;
            width: auto;
            max-width: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            image-rendering: -webkit-optimize-contrast;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        #controls-area {
            width: 100%;
            height: 140px; /* ç•™çµ¦æŒ‰éˆ•è¶³å¤ ç©ºé–“ */
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 20;
            padding-bottom: 20px; /* é¿é–‹ Home Indicator */
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        
        /* éœéŸ³æŒ‰éˆ• (æ”¾åœ¨ Top Bar å³å´) */
        #mute-btn {
            width: 40px;
            height: 40px;
            background-color: #555;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid #777;
        }

        /* ç™¼å°„æŒ‰éˆ• (åº•éƒ¨ä¸­å¤®è¶…å¤§æŒ‰éˆ•) */
        #fire-btn {
            width: 100px;
            height: 100px;
            background-color: #ff4444;
            border-radius: 50%;
            border: 6px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: none; /* éŠæˆ²é–‹å§‹æ‰é¡¯ç¤º */
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s;
        }
        #fire-btn:active { transform: scale(0.92); background-color: #d32f2f; }

        /* --- å½ˆçª—æ¨£å¼ --- */
        .overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(255, 255, 255, 0.95); 
            border: 5px solid #ff9800; 
            color: #333; 
            padding: 30px; 
            text-align: center; 
            border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            width: 85%;
            max-width: 360px;
            z-index: 100;
        }
        h1 { margin: 0 0 20px 0; color: #ff6f00; font-size: 32px; }
        p { font-size: 18px; line-height: 1.5; margin-bottom: 25px; color: #555; }
        
        button.menu-btn { 
            padding: 15px 0; 
            width: 100%;
            font-size: 22px; 
            cursor: pointer; 
            background-color: #ff9800; 
            border: none; 
            color: white; 
            border-radius: 50px; 
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        button.menu-btn:active { opacity: 0.8; transform: translateY(2px); }

    </style>
</head>
<body>

    <div id="top-bar">
        <div id="livesDisplay" style="color: #ff6b6b;">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
        <div id="scoreDisplay">åˆ†æ•¸: 0</div>
        <div id="mute-btn" onpointerdown="toggleMute(event)">ğŸ”Š</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="640" height="960"></canvas>
        
        <div id="start-screen" class="overlay">
            <h1>ğŸ· å°è±¬æ°£çƒæˆ°</h1>
            <p>
                <b>ç›´å‘æ“ä½œæ¨¡å¼</b><br>
                é»æ“Šä¸‹æ–¹ç´…è‰²æŒ‰éˆ•ç™¼å°„<br>
                ä¿è­·æ°£çƒä¸è¢«å¤§é‡ç‹¼æˆ³ç ´ï¼
            </p>
            <button class="menu-btn" onpointerdown="startGame(event)">â–¶ é–‹å§‹éŠæˆ²</button>
        </div>

        <div id="game-over" class="overlay" style="display: none;">
            <h1>éŠæˆ²çµæŸ</h1>
            <p id="final-score" style="font-size: 28px; font-weight: bold; color:#333;">æœ€çµ‚åˆ†æ•¸: 0</p>
            <button class="menu-btn" onpointerdown="resetGame(event)">ğŸ”„ å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <div id="controls-area">
        <div id="fire-btn" onpointerdown="playerShoot(event)">ç™¼å°„</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        const PIG_X = 50; // å°è±¬åœ¨ç›´ç‰ˆä¸­ç¨å¾®é å·¦ä¸€é»

        // --- éŸ³æ•ˆç³»çµ± (Safari å„ªåŒ–ç‰ˆ) ---
        const sounds = {
            bgm: new Audio('sounds/bgm.mp3'),
            shoot: new Audio('sounds/shoot.mp3'),
            pop: new Audio('sounds/pop.mp3'),
            fall: new Audio('sounds/fall.mp3'),
            score: new Audio('sounds/score.mp3'),
            hurt: new Audio('sounds/hurt.mp3')
        };
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.3;

        // iOS Audio è§£é–æ©Ÿåˆ¶
        function unlockAudio() {
            const emptySource = ctx.createBufferSource ? ctx.createBufferSource() : null; // Dummy check
            Object.values(sounds).forEach(s => {
                s.load();
                s.play().then(() => {
                    s.pause();
                    s.currentTime = 0;
                }).catch(() => {});
            });
            document.removeEventListener('pointerdown', unlockAudio);
        }
        document.addEventListener('pointerdown', unlockAudio, {once:true});

        // éœéŸ³æ§åˆ¶
        let isMuted = false;
        function toggleMute(e) {
            if(e) e.stopPropagation();
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) {
                btn.innerText = 'ğŸ”‡';
                sounds.bgm.pause();
            } else {
                btn.innerText = 'ğŸ”Š';
                if (isGameRunning) sounds.bgm.play().catch(()=>{});
            }
        }

        function playSound(name) {
            if (isMuted) return;
            const sound = sounds[name];
            if (sound) {
                if (name === 'shoot' || name === 'pop') {
                    const clone = sound.cloneNode();
                    clone.volume = sound.volume;
                    clone.play().catch(()=>{});
                } else {
                    sound.currentTime = 0;
                    sound.play().catch(()=>{});
                }
            }
        }

        // --- éŠæˆ²é‚è¼¯è®Šæ•¸ ---
        let score = 0;
        let lives = 5;
        let isGameRunning = false;
        let frameCount = 0;

        // --- é¡åˆ¥å®šç¾© ---
        class Pig {
            constructor() {
                this.width = 60; // ç›´ç‰ˆç•«é¢å¤§ï¼Œå°è±¬ç¨å¾®ç•«å¤§ä¸€é»
                this.height = 60;
                this.x = PIG_X; 
                this.y = HEIGHT / 2;
                this.speed = 4; // å¢åŠ ç§»å‹•é€Ÿåº¦é©æ‡‰é•·ç•«é¢
                this.direction = 1;
            }
            update() {
                this.y += this.speed * this.direction;
                // é‚Šç•Œæª¢æŸ¥
                if (this.y <= 10) { this.y = 10; this.direction = 1; }
                if (this.y + this.height >= HEIGHT - 10) { this.y = HEIGHT - 10 - this.height; this.direction = -1; }
            }
            draw() {
                // ç°¡æ˜“å°è±¬ç¹ªåœ–
                ctx.fillStyle = '#FFC0CB'; 
                // èº«é«”
                ctx.beginPath();
                ctx.roundRect(this.x, this.y, this.width, this.height, 10);
                ctx.fill();
                // çœ¼ç›
                ctx.fillStyle = 'black'; 
                ctx.beginPath(); ctx.arc(this.x + 40, this.y + 20, 4, 0, Math.PI*2); ctx.fill();
                // é¼»å­
                ctx.fillStyle = '#ff69b4'; 
                ctx.beginPath(); ctx.ellipse(this.x + 45, this.y + 35, 10, 8, 0, 0, Math.PI*2); ctx.fill();
            }
        }

        class Arrow {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.width = 25; this.height = 8;
                this.speed = 10; // å°„æ“Šé€Ÿåº¦åŠ å¿«
                this.markedForDeletion = false;
            }
            update() {
                this.x += this.speed;
                if (this.x > WIDTH) this.markedForDeletion = true;
            }
            draw() {
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                // ç®­é ­
                ctx.beginPath();
                ctx.moveTo(this.x + this.width, this.y - 4);
                ctx.lineTo(this.x + this.width + 12, this.y + 4);
                ctx.lineTo(this.x + this.width, this.y + 12);
                ctx.fill();
            }
        }

        class Wolf {
            constructor() {
                this.width = 50; this.height = 60;
                // ç›´ç‰ˆèª¿æ•´ï¼šç”Ÿæˆç¯„åœé™åˆ¶åœ¨å³åŠé‚Š
                const spawnMinX = 300; 
                this.x = Math.random() * (WIDTH - spawnMinX - 70) + spawnMinX;
                this.y = -60; // å¾ç•«é¢æ›´ä¸Šæ–¹æ‰è½
                this.speedY = Math.random() * 1.5 + 0.5; 
                this.fallSpeed = 9; 
                this.balloonRadius = 30; 
                this.hasBalloon = true;
                this.markedForDeletion = false;
                this.fallSoundPlayed = false;
            }
            update() {
                if (this.hasBalloon) {
                    this.y += this.speedY;
                } else {
                    this.y += this.fallSpeed;
                    if (!this.fallSoundPlayed) {
                        playSound('fall');
                        this.fallSoundPlayed = true;
                    }
                }
                
                if (this.y > HEIGHT) {
                    if (this.hasBalloon) {
                        // å¸¶è‘—æ°£çƒè½åœ°æ‰£è¡€
                        lives--; playSound('hurt'); updateUI(); this.markedForDeletion = true;
                        if (lives <= 0) gameOver();
                    } else {
                        // è¢«å°„ç ´æ°£çƒè½åœ°å¾—åˆ†
                        score += 100; playSound('score'); updateUI(); this.markedForDeletion = true;
                    }
                }
            }
            draw() {
                if (this.hasBalloon) {
                    // æ°£çƒ
                    ctx.fillStyle = '#ff5252'; 
                    ctx.beginPath(); 
                    ctx.arc(this.x + this.width/2, this.y - 20, this.balloonRadius, 0, Math.PI * 2); 
                    ctx.fill();
                    // æ°£çƒç·š
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(this.x + this.width/2, this.y - 20 + this.balloonRadius); 
                    ctx.lineTo(this.x + this.width/2, this.y + 10); ctx.stroke();
                }
                // ç‹¼èº«é«”
                ctx.fillStyle = this.hasBalloon ? '#555' : '#333'; 
                ctx.fillRect(this.x, this.y, this.width, this.height);
                // ç‹¼çœ¼
                ctx.fillStyle = 'yellow';
                ctx.fillRect(this.x + 8, this.y + 15, 10, 10); 
                ctx.fillRect(this.x + 32, this.y + 15, 10, 10);
            }
        }

        // --- éŠæˆ²æ§åˆ¶èˆ‡è¿´åœˆ ---
        let pig = new Pig();
        let arrows = [];
        let wolves = [];

        function playerShoot(e) {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            
            if (isGameRunning) {
                arrows.push(new Arrow(pig.x + pig.width, pig.y + pig.height/2));
                playSound('shoot');
                
                // æŒ‰éˆ•å‹•ç•«
                const btn = document.getElementById('fire-btn');
                btn.style.transform = 'scale(0.9)';
                setTimeout(() => btn.style.transform = 'scale(1)', 80);
            }
        }

        // éµç›¤æ”¯æ´
        window.addEventListener('keydown', e => {
            if (e.code === 'Space' || e.key === 'Enter') {
                playerShoot();
            }
        });

        function checkCollisions() {
            arrows.forEach(arrow => {
                wolves.forEach(wolf => {
                    if (wolf.hasBalloon && !arrow.markedForDeletion) {
                        // ç°¡å–®çš„åœ“å½¢èˆ‡çŸ©å½¢ç¢°æ’æª¢æ¸¬
                        const balloonX = wolf.x + wolf.width/2;
                        const balloonY = wolf.y - 20;
                        const arrowTipX = arrow.x + arrow.width;
                        const arrowTipY = arrow.y + arrow.height/2;
                        
                        // è¨ˆç®—è·é›¢
                        const dist = Math.sqrt((balloonX - arrowTipX)**2 + (balloonY - arrowTipY)**2);
                        if (dist < wolf.balloonRadius + 5) {
                            wolf.hasBalloon = false; 
                            arrow.markedForDeletion = true; 
                            playSound('pop');
                        }
                    }
                });
            });
        }

        function drawBackground() {
            // å¤©ç©º
            ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,WIDTH,HEIGHT);
            
            // å·¦å´å®‰å…¨ç·š (è±¬çš„ç§»å‹•è»Œé“)
            ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 4; 
            ctx.beginPath(); ctx.moveTo(PIG_X + 30, 0); ctx.lineTo(PIG_X + 30, HEIGHT); ctx.stroke();
            
            // åœ°æ¿
            ctx.fillStyle = '#4CAF50'; ctx.fillRect(0, HEIGHT-20, WIDTH, 20);
            
            // é›²æœµè£é£¾
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.beginPath(); ctx.arc(WIDTH-100, 100, 40, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(150, 300, 30, 0, Math.PI*2); ctx.fill();
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = `åˆ†æ•¸: ${score}`;
            document.getElementById('livesDisplay').innerText = `${'â¤ï¸'.repeat(Math.max(0, lives))}`;
        }

        function startGame(e) {
            if(e) e.preventDefault();
            
            // æ’­æ”¾ä¸¦è§£é–éŸ³æ•ˆ
            if (!isMuted) sounds.bgm.play().catch(()=>{});

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('fire-btn').style.display = 'flex';
            
            resetGameLogic(); isGameRunning = true; gameLoop();
        }

        function gameOver() {
            isGameRunning = false; sounds.bgm.pause();
            document.getElementById('fire-btn').style.display = 'none';
            document.getElementById('final-score').innerText = `æœ€çµ‚åˆ†æ•¸: ${score}`;
            document.getElementById('game-over').style.display = 'block';
        }

        function resetGame(e) { startGame(e); }
        
        function resetGameLogic() { 
            score = 0; 
            lives = 5; 
            frameCount = 0; 
            pig = new Pig(); 
            arrows = []; 
            wolves = []; 
            updateUI(); 
        }

        function gameLoop() {
            if (!isGameRunning) return;
            
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            drawBackground();
            
            pig.update(); pig.draw();
            
            frameCount++;
            // èª¿æ•´ç”Ÿæˆé »ç‡
            let spawnRate = 100;
            if (score > 1000) spawnRate = 80;
            if (score > 2000) spawnRate = 60;
            
            if (frameCount % spawnRate === 0) wolves.push(new Wolf());
            
            arrows.forEach(arrow => { arrow.update(); arrow.draw(); });
            arrows = arrows.filter(arrow => !arrow.markedForDeletion);
            
            wolves.forEach(wolf => { wolf.update(); wolf.draw(); });
            wolves = wolves.filter(wolf => !wolf.markedForDeletion);
            
            checkCollisions();
            requestAnimationFrame(gameLoop);
        }

        // åˆå§‹ç¹ªè£½
        drawBackground();
        updateUI();

    </script>
</body>
</html>
