<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°è±¬æŠµæŠ—å¤§é‡ç‹¼ - iPad Mini ç‰ˆ</title>
    <style>
        /* ç¦æ­¢ iOS é è¨­çš„é¸å–èˆ‡è§¸æ§è¡Œç‚º */
        * {
            -webkit-touch-callout: none; /* ç¦æ­¢é•·æŒ‰é¸å–® */
            -webkit-user-select: none;   /* ç¦æ­¢é¸å–æ–‡å­— */
            user-select: none;
            touch-action: none;          /* ç¦æ­¢ç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚º(å¦‚æ»¾å‹•/ç¸®æ”¾) */
        }

        body { 
            margin: 0; 
            background-color: #333; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            /* ä½¿ç”¨ dvh (dynamic viewport height) è§£æ±º Safari ç¶²å€åˆ—ä¼¸ç¸®å•é¡Œ */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }
        
        canvas { 
            background-color: #87CEEB; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            /* è®“ Canvas è‡ªå‹•ç¸®æ”¾ä»¥é©æ‡‰è¢å¹•ï¼Œä½†ä¿æŒæ¯”ä¾‹ */
            max-width: 100%;
            max-height: 100dvh;
            aspect-ratio: 4/3; 
            border: 5px solid #fff;
            border-radius: 12px;
            /* ç¢ºä¿æ¸²æŸ“æ¸…æ™° */
            image-rendering: -webkit-optimize-contrast;
        }

        #ui-layer { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            pointer-events: none; 
            z-index: 10;
        }
        
        .stat { 
            font-size: 24px; /* iPad Mini ä¸Šç¨å¾®èª¿æ•´å­—é«”å¤§å° */
            font-weight: bold; 
            color: #333; 
            margin-bottom: 5px; 
            text-shadow: 2px 2px 0px white; 
            font-family: monospace;
        }
        
        /* --- éœéŸ³æŒ‰éˆ• --- */
        #mute-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid #333;
            border-radius: 50%;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 300; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            /* é‡å°è§¸æ§å„ªåŒ– */
            -webkit-tap-highlight-color: transparent;
        }
        #mute-btn:active {
            transform: scale(0.9);
            background-color: #eee;
        }

        /* --- ç™¼å°„æŒ‰éˆ• (é‡å°å¹³æ¿å³æ‰‹æ‹‡æŒ‡å„ªåŒ–) --- */
        #fire-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 120px; /* ç¨å¾®ç¸®å°ä¸€é»ä»¥å…é®æ“‹å¤ªå¤šç•«é¢ï¼Œä½†åœ¨iPad Miniä¸Šä»å¤ å¤§ */
            height: 120px;
            background-color: #ff4444;
            border-radius: 50%;
            border: 6px solid white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 100;
            -webkit-tap-highlight-color: transparent;
            /* å¢åŠ è§¸æ§æ„Ÿæ‡‰å€ä½†ä¸æ”¹è®Šè¦–è¦ºå¤§å° */
        }
        #fire-btn:active { 
            transform: scale(0.9); 
            background-color: #cc0000; 
        }

        /* --- å½ˆçª—æ¨£å¼ --- */
        .overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(255, 255, 255, 0.98); 
            border: 6px solid #ff9800; 
            color: #333; 
            padding: 40px; 
            text-align: center; 
            border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            width: 80%; /* éŸ¿æ‡‰å¼å¯¬åº¦ */
            max-width: 400px;
            z-index: 200;
        }
        h1 { margin-top: 0; color: #ff6f00; font-size: 36px; margin-bottom: 20px; }
        p { font-size: 18px; line-height: 1.6; margin-bottom: 30px;}
        
        button.menu-btn { 
            padding: 15px 40px; 
            font-size: 24px; 
            cursor: pointer; 
            background-color: #ff9800; 
            border: none; 
            color: white; 
            border-radius: 50px; 
            border-bottom: 6px solid #e65100; 
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        button.menu-btn:active { 
            transform: translateY(4px); 
            border-bottom: 0px; 
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="ui-layer">
        <div class="stat" id="scoreDisplay">åˆ†æ•¸: 0</div>
        <div class="stat" id="livesDisplay" style="color: red;">è¡€é‡: â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
    </div>

    <div id="mute-btn" onpointerdown="toggleMute(event)">ğŸ”Š</div>

    <div id="fire-btn" onpointerdown="playerShoot(event)">
        ç™¼å°„!
    </div>

    <div id="start-screen" class="overlay">
        <h1>ğŸ· å°è±¬æ°£çƒæˆ° ğŸº</h1>
        <p>
            é»æ“Šç•«é¢ä¸Šçš„ <strong style="color:red">ç´…è‰²æŒ‰éˆ•</strong> ä¾†å°„æ“Šï¼<br>
            ä¿è­·å°è±¬ä¸è¦è¢«å¤§é‡ç‹¼æŠ“èµ°
        </p>
        <button class="menu-btn" onpointerdown="startGame(event)">â–¶ é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game-over" class="overlay" style="display: none;">
        <h1>éŠæˆ²çµæŸ</h1>
        <p id="final-score" style="font-size: 28px; font-weight: bold;">æœ€çµ‚åˆ†æ•¸: 0</p>
        <button class="menu-btn" onpointerdown="resetGame(event)">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        const PIG_X = 60;

        // --- éŸ³æ•ˆç®¡ç†å™¨ ---
        // Safari éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰èƒ½æ’­æ”¾ AudioContextï¼Œé€™è£¡ä½¿ç”¨å‚³çµ± Audio æ¨™ç±¤è¼ƒç°¡å–®ï¼Œä½†ä»å—é™
        const sounds = {
            bgm: new Audio('sounds/bgm.mp3'),
            shoot: new Audio('sounds/shoot.mp3'),
            pop: new Audio('sounds/pop.mp3'),
            fall: new Audio('sounds/fall.mp3'),
            score: new Audio('sounds/score.mp3'),
            hurt: new Audio('sounds/hurt.mp3')
        };
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.3;

        // é å…ˆè¼‰å…¥éŸ³æ•ˆ (iOS Safari Trick)
        function unlockAudio() {
            Object.values(sounds).forEach(sound => {
                sound.load();
                // å˜—è©¦æ’­æ”¾ä¸€ç¬é–“ç„¶å¾Œæš«åœï¼Œè§£é– iOS Audio é™åˆ¶
                const promise = sound.play();
                if (promise !== undefined) {
                    promise.then(_ => {
                        sound.pause();
                        sound.currentTime = 0;
                    }).catch(error => {
                        // Auto-play was prevented
                    });
                }
            });
            // ç§»é™¤ç›£è½å™¨ï¼ŒåªåŸ·è¡Œä¸€æ¬¡
            document.removeEventListener('pointerdown', unlockAudio);
            document.removeEventListener('touchstart', unlockAudio);
        }
        
        // ç¬¬ä¸€æ¬¡è§¸æ§æ™‚è§£é–éŸ³æ•ˆ
        document.addEventListener('pointerdown', unlockAudio, {once:true});

        // --- éœéŸ³æ§åˆ¶ ---
        let isMuted = false;

        function toggleMute(e) {
            if(e) e.preventDefault(); // é˜²æ­¢è§¸æ§ç©¿é€
            isMuted = !isMuted; 
            const btn = document.getElementById('mute-btn');
            
            if (isMuted) {
                btn.innerText = 'ğŸ”‡';
                sounds.bgm.pause();
            } else {
                btn.innerText = 'ğŸ”Š';
                if (isGameRunning) {
                    sounds.bgm.play().catch(e => console.log('BGM play failed:', e));
                }
            }
        }

        function playSound(name) {
            if (isMuted) return;
            const sound = sounds[name];
            if (sound) {
                // è¤‡è£½ç¯€é»ä»¥æ”¯æ´é‡ç–Šæ’­æ”¾ (ä¾‹å¦‚é€£çºŒå°„æ“Š)
                if (name === 'shoot' || name === 'pop') {
                    const clone = sound.cloneNode();
                    clone.volume = sound.volume;
                    clone.play().catch(e => {});
                } else {
                    sound.currentTime = 0;
                    sound.play().catch(e => {}); 
                }
            }
        }

        // éŠæˆ²è®Šæ•¸
        let score = 0;
        let lives = 5;
        let isGameRunning = false;
        let frameCount = 0;

        // --- é¡åˆ¥å®šç¾© ---
        class Pig {
            constructor() {
                this.width = 40; this.height = 40;
                this.x = PIG_X; this.y = HEIGHT / 2;
                this.speed = 3; 
                this.direction = 1;
            }
            update() {
                this.y += this.speed * this.direction;
                if (this.y <= 0) { this.y = 0; this.direction = 1; }
                if (this.y + this.height >= HEIGHT) { this.y = HEIGHT - this.height; this.direction = -1; }
            }
            draw() {
                ctx.fillStyle = '#FFC0CB'; ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = 'black'; ctx.fillRect(this.x + 25, this.y + 10, 5, 5);
                ctx.fillStyle = '#ff69b4'; ctx.fillRect(this.x + 28, this.y + 20, 12, 10);
            }
        }

        class Arrow {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.width = 20; this.height = 5;
                this.speed = 8; this.markedForDeletion = false;
            }
            update() {
                this.x += this.speed;
                if (this.x > WIDTH) this.markedForDeletion = true;
            }
            draw() {
                ctx.fillStyle = 'black'; ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.beginPath(); ctx.moveTo(this.x+this.width, this.y-2); ctx.lineTo(this.x+this.width+10, this.y+2.5); ctx.lineTo(this.x+this.width, this.y+7); ctx.fill();
            }
        }

        class Wolf {
            constructor() {
                this.width = 40; this.height = 50;
                const branchStart = 400;
                this.x = Math.random() * (WIDTH - branchStart - 60) + branchStart;
                this.y = 90;
                this.speedY = Math.random() * 0.8 + 0.3; 
                this.fallSpeed = 8; 
                this.balloonRadius = 28; 
                this.hasBalloon = true;
                this.markedForDeletion = false;
                this.fallSoundPlayed = false;
            }
            update() {
                if (this.hasBalloon) {
                    this.y += this.speedY;
                } else {
                    this.y += this.fallSpeed;
                    if (!this.fallSoundPlayed) {
                        playSound('fall');
                        this.fallSoundPlayed = true;
                    }
                }
                if (this.y + this.height >= HEIGHT) {
                    this.y = HEIGHT - this.height;
                    if (this.hasBalloon) {
                        lives--; playSound('hurt'); updateUI(); this.markedForDeletion = true;
                        if (lives <= 0) gameOver();
                    } else {
                        score += 100; playSound('score'); updateUI(); this.markedForDeletion = true;
                    }
                }
            }
            draw() {
                if (this.hasBalloon) {
                    ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y - 15, this.balloonRadius, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.arc(this.x + this.width/2 - 8, this.y - 23, 6, 0, Math.PI * 2); ctx.fill();
                    ctx.strokeStyle = 'white'; ctx.beginPath(); ctx.moveTo(this.x + this.width/2, this.y - 15 + this.balloonRadius); ctx.lineTo(this.x + this.width/2, this.y); ctx.stroke();
                }
                ctx.fillStyle = this.hasBalloon ? '#555' : '#333'; ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = 'yellow';
                let eyeSize = this.hasBalloon ? 8 : 12; 
                ctx.fillRect(this.x + 5, this.y + 10, eyeSize, eyeSize); ctx.fillRect(this.x + 25, this.y + 10, eyeSize, eyeSize);
            }
        }

        // --- éŠæˆ²æ§åˆ¶ ---
        let pig = new Pig();
        let arrows = [];
        let wolves = [];

        // ä¿®æ”¹ç‚ºæ¥æ”¶ event åƒæ•¸
        function playerShoot(e) {
            if(e) {
                e.preventDefault(); // é˜²æ­¢ iOS é›™æ“Šç¸®æ”¾
                e.stopPropagation();
            }
            
            if (isGameRunning) {
                arrows.push(new Arrow(pig.x + pig.width, pig.y + pig.height/2));
                playSound('shoot');
                
                const btn = document.getElementById('fire-btn');
                btn.style.transform = 'scale(0.9)';
                setTimeout(() => btn.style.transform = 'scale(1)', 100);
            }
        }

        // éµç›¤æ”¯æ´ (å¤–æ¥éµç›¤æ™‚)
        window.addEventListener('keydown', e => {
            if (e.code === 'Space' || e.key === 'Enter' || e.keyCode === 13) {
                playerShoot();
                e.preventDefault(); 
            }
        });

        function checkCollisions() {
            arrows.forEach(arrow => {
                wolves.forEach(wolf => {
                    if (wolf.hasBalloon && !arrow.markedForDeletion) {
                        const bx = wolf.x + wolf.width/2;
                        const by = wolf.y - 15;
                        const ax = arrow.x + arrow.width;
                        const ay = arrow.y + arrow.height/2;
                        if (Math.sqrt((bx-ax)**2 + (by-ay)**2) < wolf.balloonRadius + 10) {
                            wolf.hasBalloon = false; arrow.markedForDeletion = true; playSound('pop');
                        }
                    }
                });
            });
        }

        function drawBackground() {
            ctx.fillStyle = '#b0e0e6'; ctx.fillRect(0,0,WIDTH,HEIGHT);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(PIG_X + 20, 0); ctx.lineTo(PIG_X + 20, HEIGHT); ctx.stroke();
            ctx.fillStyle = '#8B4513'; ctx.fillRect(WIDTH - 100, 0, 100, HEIGHT);
            ctx.fillRect(WIDTH/2, 60, WIDTH/2, 30);
            ctx.fillStyle = '#32CD32'; ctx.beginPath(); ctx.arc(WIDTH - 100, 60, 40, 0, Math.PI*2); ctx.arc(WIDTH/2, 60, 30, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#4CAF50'; ctx.fillRect(0, HEIGHT-10, WIDTH, 10);
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = `åˆ†æ•¸: ${score}`;
            document.getElementById('livesDisplay').innerText = `è¡€é‡: ${'â¤ï¸'.repeat(Math.max(0, lives))}`;
        }

        function startGame(e) {
            if(e) e.preventDefault();
            
            // é‡è¦ï¼šåœ¨ç”¨æˆ¶é»æ“Šé–‹å§‹æŒ‰éˆ•çš„ç¬é–“å˜—è©¦æ’­æ”¾ä¸¦æ¢å¾©éŸ³æ¨‚
            if (!isMuted) {
                sounds.bgm.play().then(() => {
                    // æ’­æ”¾æˆåŠŸ
                }).catch(err => {
                    console.log("Audio play failed (waiting for interaction):", err);
                });
            }

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('fire-btn').style.display = 'flex';
            
            resetGameLogic(); isGameRunning = true; gameLoop();
        }

        function gameOver() {
            isGameRunning = false; sounds.bgm.pause();
            document.getElementById('fire-btn').style.display = 'none';
            document.getElementById('final-score').innerText = `æœ€çµ‚åˆ†æ•¸: ${score}`;
            document.getElementById('game-over').style.display = 'block';
        }

        function resetGame(e) { startGame(e); }
        function resetGameLogic() { score = 0; lives = 5; frameCount = 0; pig = new Pig(); arrows = []; wolves = []; updateUI(); }

        function gameLoop() {
            if (!isGameRunning) return;
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            drawBackground();
            pig.update(); pig.draw();
            frameCount++;
            let spawnRate = 120;
            if (score > 500) spawnRate = 100;
            if (frameCount % spawnRate === 0) wolves.push(new Wolf());
            arrows.forEach(arrow => { arrow.update(); arrow.draw(); });
            arrows = arrows.filter(arrow => !arrow.markedForDeletion);
            wolves.forEach(wolf => { wolf.update(); wolf.draw(); });
            wolves = wolves.filter(wolf => !wolf.markedForDeletion);
            checkCollisions();
            requestAnimationFrame(gameLoop);
        }
        
        drawBackground();
        updateUI();

    </script>
</body>
</html>
